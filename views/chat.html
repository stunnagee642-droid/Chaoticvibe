<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ChaoticVibe Chat</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="chat-body">

  <audio id="notifySound" src="/notify.mp3" preload="auto"></audio>

  <div class="chat-wrapper">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="/EWbndKy4Tlesld1s5HLj9w.webp" class="logo-sm" alt="">
        <h2>ChaoticVibe</h2>
      </div>
      <h3>ðŸŸ¢ Online</h3>
      <ul id="onlineList"></ul>
      <a href="/" class="logout">Logout</a>
    </aside>

    <!-- Main Chat -->
    <main class="chat-main">
      <div id="messages" class="messages"></div>
      <div id="typing" class="typing"></div>

      <form id="msgForm" class="msgForm">
        <input id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button>Send</button>
      </form>
    </main>
  </div>

<script>
const username = new URLSearchParams(window.location.search).get("user");
if (!username) location.href = "/";

const socket = io();
socket.emit("join", username);

const messagesEl = document.getElementById("messages");
const onlineList = document.getElementById("onlineList");
const typingEl = document.getElementById("typing");
const notifySound = document.getElementById("notifySound");

function avatarLetter(name) {
  return name[0]?.toUpperCase() || "?";
}

socket.on("message", (msg) => {
  const div = document.createElement("div");
  div.className = msg.username === username ? "msg me" : "msg";
  div.innerHTML = `
    <div class="avatar">${avatarLetter(msg.username)}</div>
    <div class="bubble">
      <b>${msg.username}</b><br>${msg.text}
      <small>${msg.timestamp || ""}</small>
    </div>`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  if (msg.username !== username && msg.username !== "System") notifySound.play();
});

socket.on("loadMessages", (msgs) => {
  messagesEl.innerHTML = "";
  msgs.forEach(m => {
    const div = document.createElement("div");
    div.className = m.username === username ? "msg me" : "msg";
    div.innerHTML = `
      <div class="avatar">${avatarLetter(m.username)}</div>
      <div class="bubble">
        <b>${m.username}</b><br>${m.text}
      </div>`;
    messagesEl.appendChild(div);
  });
});

socket.on("onlineUsers", (list) => {
  onlineList.innerHTML = "";
  list.forEach(u => {
    const li = document.createElement("li");
    li.textContent = u === username ? `${u} (You)` : u;
    onlineList.appendChild(li);
  });
});

socket.on("typing", (data) => {
  if (data.user !== username) {
    typingEl.textContent = data.text;
    setTimeout(() => typingEl.textContent = "", 2000);
  }
});

const input = document.getElementById("msgInput");
input.addEventListener("input", () => {
  socket.emit("typing", { user: username, text: `${username} is typing...` });
});

document.getElementById("msgForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const val = input.value.trim();
  if (!val) return;
  socket.emit("message", val);
  input.value = "";
});
</script>

</body>
</html>
